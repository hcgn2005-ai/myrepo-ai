name: Build CloudStream plugins

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify gradlew exists
      run: |
        if [ ! -f "gradlew" ]; then
          echo "âŒ gradlew missing! Run 'gradle wrapper' locally first."
          exit 1
        fi
        ls -la gradlew*

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Build plugins
      run: ./gradlew make --stacktrace --no-daemon

    - name: List generated .cs3 files
      run: find . -name "*.cs3" || echo "No .cs3 files found!"

    - name: Deploy to builds branch
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git fetch origin builds || true
        git checkout -B builds origin/builds || git checkout -B builds
        
        rm -rf plugins || true
        mkdir -p plugins
        
        find .. -name "*.cs3" -exec cp {} plugins/ \; || echo "No plugins copied"
        
        # Generate plugins.json
        if ls plugins/*.cs3 >/dev/null 2>&1; then
          echo '{ "name": "MyRepo AI", "plugins": [' > plugins.json
          FIRST=true
          for file in plugins/*.cs3; do
            if [ "$FIRST" = false ]; then echo "," >> plugins.json; fi
            FIRST=false
            name=$(basename "$file" .cs3)
            echo "{\"name\":\"$name\",\"id\":\"$name\",\"version\":1,\"url\":\"https://github.com/hcgn2005-ai/myrepo-ai/raw/builds/plugins/$name.cs3\",\"langs\":[\"en\"],\"tvTypes\":[\"Anime\"]}" >> plugins.json
          done
          echo ']}' >> plugins.json
          cp plugins.json .
        else
          echo "No plugins found, skipping plugins.json"
        fi
        
        git add -A
        git commit -m "Update builds $(date)" || echo "No changes"
        git push origin HEAD:builds || echo "Push failed"
